<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chrono Pro V9.1</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#007bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  body{font-family:Arial,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:100vh;margin:0;background:#f0f0f0;padding:20px 0}
  #workout-container{text-align:center;background:white;padding:25px;border-radius:12px;box-shadow:0 6px 12px rgba(0,0,0,.15);max-width:600px;width:90%}
  #exercise-image{width:100%;max-width:300px;height:auto;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
  #timer{font-size:56px;font-weight:bold;margin:20px 0;color:#007bff}
  #exercise-info,#series-info,#status{font-size:20px;margin:10px 0;font-weight:600}
  #series-info{color:#555;font-weight:400}
  button{padding:12px 20px;font-size:16px;margin:6px 4px;cursor:pointer;border:none;border-radius:6px;background:#007bff;color:white;transition:all .2s}
  button:hover:not(:disabled){background:#0056b3;transform:translateY(-1px)}
  button:disabled{background:#ccc;cursor:not-allowed}
  #config-panel{display:none;margin-top:25px;padding:20px;background:#f8f9fa;border-radius:10px;width:90%;max-width:560px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
  #exercise-list{max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:6px;padding:8px;background:white;margin-bottom:15px}
  .exercise-entry{border-bottom:1px solid #eee;padding:12px 0;display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:14px}
  .exercise-entry input{padding:8px;font-size:14px;border:1px solid #ddd;border-radius:4px}
  .exercise-entry input[type="text"], input[type="number"]{width:100px}
  .exercise-entry input[type="text"]:nth-child(1){width:140px}
  #total-time-info,#autosave-status{font-size:14px;margin-top:8px}
  #total-time-info{color:#007bff;font-weight:600}
  #autosave-status{color:#28a745;opacity:0;transition:opacity .3s}
  .help{color:#666;font-size:13px;margin-top:5px;line-height:1.5}
  .legend{font-size:13px;color:#555;margin-bottom:8px}
  .delete-btn{background:#dc3545!important;padding:8px 12px!important;min-width:40px;border-radius:6px;font-size:18px}
  .version{color:#007bff;font-size:13px;font-weight:bold;margin-top:10px}
  .error-msg{color:#dc3545;font-size:14px;margin-top:10px;display:none}
</style>
</head>
<body>

<div id="workout-container">
  <img id="exercise-image" src="https://i.imgur.com/IHCEoad.png" alt="Préparation">
  <div id="exercise-info">Préparation</div>
  <div id="series-info"></div>
  <div id="timer">00:10</div>
  <div id="status">Prêt à commencer</div>
  <div class="error-msg" id="error-msg"></div>
  <div style="margin:20px 0">
    <button id="prev-btn">Précédent</button>
    <button id="next-btn">Suivant</button>
  </div>
  <button id="start-btn" style="font-size:18px;padding:16px 40px">Démarrer</button><br>
  <button id="pause-btn">Pause</button>
  <button id="reset-btn">Réinitialiser</button>
  <button id="config-btn">Configurer</button>
  <div class="version">Chrono Pro V9.1 — Bugs corrigés ✓</div>
</div>

<div id="config-panel">
  <h2>Configuration</h2>
  <label>Mise en place (s) : <input type="number" id="setup-time" value="10" min="0"></label><br><br>
  <label>Séquence :</label>
  <input type="text" id="sequence-input" value="10x(5-P30-13-P30 + 5x(12-P30))" style="width:100%;padding:10px;font-family:monospace;font-size:15px">
  <div class="help">
    V9.1 = syntaxe Excel + validation robuste<br>
    → 10x(5-P30-13-P30 + 5x(12-P30)) → 10 fois tout le bloc (avec 5 finishers à chaque tour)<br>
    → 4x(A-P60 + 3x(B-P20 + 2x(C))) → imbriqué à fond, tout est respecté<br>
    → 8x(1-P20) → toujours OK<br>
    Le + à l'intérieur des parenthèses est maintenant parfaitement géré !
  </div>

  <h3>Exercices</h3>
  <div class="legend">[1] Nom [2] Répétitions [3] Temps travail [4] URL image [5] Image locale</div>
  <div id="exercise-list"></div>

  <button id="add-exercise">+ Exercice</button>
  <button id="save-config">Enregistrer</button>
  <button id="export-config">Exporter JSON</button><br><br>
  <label>Importer config : <input type="file" id="import-config" accept=".json"></label>
  <div id="total-time-info">Temps total : …</div>
  <div id="autosave-status"></div>
</div>

<script>
// ========== AUDIO ==========
let audioCtx = null;
let lastBeepTime = 0;

function getAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const unlock = () => { audioCtx.resume(); };
    document.body.addEventListener('touchstart', unlock, {once:true});
    document.body.addEventListener('click', unlock, {once:true});
  }
  return audioCtx;
}

function beep(freq = 800, duration = 200) {
  try {
    // Éviter les beeps qui se chevauchent (minimum 50ms entre chaque)
    const now = Date.now();
    if (now - lastBeepTime < 50) return;
    lastBeepTime = now;

    const ctx = getAudioContext();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); 
    g.connect(ctx.destination);
    o.frequency.value = freq;
    o.type = 'sine';
    g.gain.setValueAtTime(0.001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration/1000);
    o.start(); 
    o.stop(ctx.currentTime + duration/1000);
  } catch (err) {
    console.warn("Beep failed:", err);
  }
}

// ========== DONNÉES ==========
let exercises = JSON.parse(localStorage.getItem('chronoPro_exercises')) || [
  {name:"Dips lestés", reps:"3—5", workTime:40, image:"https://images.unsplash.com/photo-1517836357463-d25dfeac3438"},
  {name:"HSPU / Pompes piquées", reps:"4—6", workTime:40, image:"https://images.unsplash.com/photo-1517838277536-f5f99be501cd"},
  {name:"Pompes lestées", reps:"6—8", workTime:40, image:"https://images.unsplash.com/photo-1530822847156-5df3f8f02b07"},
  {name:"Tractions pronation", reps:"5—7", workTime:40, image:"https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b"},
  {name:"Squat arrière", reps:"8—10", workTime:45, image:"https://images.unsplash.com/photo-1605296867304-46d5465a13f1"},
  {name:"Développé militaire", reps:"6—8", workTime:40, image:"https://images.unsplash.com/photo-1605296867424-15a303c5d6fd"},
  {name:"Soulevé de terre", reps:"3—5", workTime:50, image:"https://images.unsplash.com/photo-1603287681838-2e11c8e89019"},
  {name:"Burpees", reps:"10-15", workTime:40, image:"https://images.unsplash.com/photo-1605296867304-46d5465a13f1"},
  {name:"Muscle-up", reps:"3-6", workTime:50, image:"https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b"},
  {name:"Finisher surprise", reps:"MAX", workTime:30, image:"https://images.unsplash.com/photo-1570545906912-5b2a3f2c8b4a"}
];

let sequenceInputValue = localStorage.getItem('chronoPro_sequence') || "10x(5-P30-13-P30 + 5x(12-P30))";
let setupTime = parseInt(localStorage.getItem('chronoPro_setupTime')) || 10;

let isSetupPhase = true;
let currentBlockIndex = -1;
let timeLeft = setupTime;
let timerInterval = null;
let isPaused = false;

// ========== PARSER V9.1 — ROBUSTE & VALIDÉ ==========
function parseSequence(input) {
  try {
    // CORRECTION: P\d+ doit être testé AVANT [\d]+ pour éviter de matcher "5" au lieu de "P5"
    const tokens = input.replace(/\s/g, '')
      .match(/\d+x\(|P\d+|[\d]+|\+|\(|\)/g) || [];
    
    if (tokens.length === 0) {
      throw new Error("Séquence vide");
    }

    const stack = [{ blocks: [], multiplier: 1 }];
    let i = 0;

    while (i < tokens.length) {
      const t = tokens[i];

      // Répétition au début d'un groupe : 5x(
      if (/^\d+x\(/.test(t)) {
        const rounds = parseInt(t);
        if (rounds <= 0 || rounds > 1000) {
          throw new Error(`Nombre de répétitions invalide: ${rounds}`);
        }
        stack.push({ blocks: [], multiplier: rounds });
        i++;
        continue;
      }

      if (t === '(') {
        i++;
        continue;
      }

      if (t === '+') {
        // Le + sépare les séquences mais ne crée pas de nouveau groupe
        i++;
        continue;
      }

      if (t === ')') {
        if (stack.length <= 1) {
          throw new Error("Parenthèse fermante sans ouverture");
        }
        const current = stack.pop();
        const parent = stack[stack.length - 1];
        
        // On répète le contenu du groupe autant de fois que demandé
        for (let r = 0; r < current.multiplier; r++) {
          parent.blocks.push(...current.blocks);
        }
        i++;
        continue;
      }

      // Exercice ou repos
      if (t.toUpperCase().startsWith('P')) {
        const duration = parseInt(t.slice(1)) || 0;
        if (duration < 0 || duration > 3600) {
          throw new Error(`Durée de repos invalide: ${duration}`);
        }
        stack[stack.length - 1].blocks.push({ type: 'rest', duration });
      } else {
        const id = parseInt(t);
        if (id <= 0 || id > exercises.length) {
          throw new Error(`Exercice ${id} n'existe pas (max: ${exercises.length})`);
        }
        stack[stack.length - 1].blocks.push({ type: 'exercise', id });
      }
      i++;
    }

    if (stack.length > 1) {
      throw new Error("Parenthèse non fermée");
    }

    const blocks = stack[0].blocks;
    if (blocks.length === 0) {
      throw new Error("Aucun exercice dans la séquence");
    }

    return blocks;
  } catch (err) {
    console.error("Erreur de parsing:", err);
    showError(`Erreur de séquence: ${err.message}`);
    return [];
  }
}

function showError(msg) {
  const el = document.getElementById("error-msg");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => { el.style.display = "none"; }, 5000);
}

// Temps total
function calculateTotalTime() {
  const blocks = parseSequence(sequenceInputValue);
  let t = setupTime;
  for (let b of blocks) {
    if (b.type === 'exercise') {
      const ex = exercises[b.id - 1];
      t += ex ? ex.workTime : 30;
    } else {
      t += b.duration;
    }
  }
  return t;
}

const formatTime = s => `${Math.floor(s/60)}m ${s%60}s`;
const formatMMSS = s => `${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;

// ========== AFFICHAGE ==========
function updateDisplay() {
  const img = document.getElementById("exercise-image");
  const info = document.getElementById("exercise-info");
  const series = document.getElementById("series-info");
  const status = document.getElementById("status");

  if (isSetupPhase) {
    info.textContent = "Préparation";
    series.textContent = "";
    img.src = "https://i.imgur.com/IHCEoad.png";
    status.textContent = "Mise en place";
  } else {
    const blocks = parseSequence(sequenceInputValue);
    const totalBlocks = blocks.length;

    if (currentBlockIndex >= totalBlocks) {
      info.textContent = "FINI !";
      series.textContent = "Entraînement terminé";
      img.src = "https://i.imgur.com/0pazk7c.png";
      status.textContent = "Bravo !";
    } else {
      const block = blocks[currentBlockIndex];
      series.textContent = `Bloc ${currentBlockIndex + 1} / ${totalBlocks}`;

      if (block.type === 'exercise') {
        const ex = exercises[block.id - 1];
        if (!ex) {
          info.textContent = "Exercice introuvable";
          img.src = "https://via.placeholder.com/300?text=Erreur";
          status.textContent = "ERREUR";
        } else {
          info.textContent = `${ex.name} (${ex.reps})`;
          img.src = ex.image || "https://via.placeholder.com/300?text=Exo";
          status.textContent = "TRAVAIL";
        }
      } else {
        info.textContent = "Repos";
        img.src = "https://i.imgur.com/IHCEoad.png";
        status.textContent = `Repos ${block.duration}s`;
      }
    }
  }
  document.getElementById("timer").textContent = formatMMSS(timeLeft);
}

// ========== TIMER (CORRIGÉ) ==========
function advanceBlock() {
  currentBlockIndex++;
  const blocks = parseSequence(sequenceInputValue);

  if (currentBlockIndex >= blocks.length) {
    clearInterval(timerInterval); 
    timerInterval = null;
    beep(1200, 400);
    setTimeout(() => beep(1400, 400), 500);
    setTimeout(() => beep(1600, 800), 1000);
    updateDisplay();
    return;
  }

  const block = blocks[currentBlockIndex];
  if (block.type === 'exercise') {
    const ex = exercises[block.id - 1];
    if (!ex) {
      console.error(`Exercice ${block.id} introuvable, skip`);
      advanceBlock(); // Skip automatiquement
      return;
    }
    timeLeft = ex.workTime;
    beep(880, 350);
  } else {
    timeLeft = block.duration;
    beep(660, 450);
  }
  updateDisplay();
}

function timerTick() {
  // Beep compte à rebours (évite chevauchement avec fin d'exercice)
  if (timeLeft <= 5 && timeLeft > 0) {
    beep(440 + timeLeft * 80, 120);
  }
  
  if (timeLeft > 0) {
    timeLeft--;
    document.getElementById("timer").textContent = formatMMSS(timeLeft);
    return;
  }
  
  // timeLeft === 0, transition vers le prochain bloc
  if (isSetupPhase) {
    isSetupPhase = false;
    currentBlockIndex = -1;
    beep(1000, 500);
  }
  advanceBlock();
}

// ========== CONTRÔLES (AMÉLIORÉS) ==========
function startWorkout() {
  if (timerInterval && !isPaused) return; // Déjà en cours
  
  if (isPaused) {
    isPaused = false;
    timerInterval = setInterval(timerTick, 1000);
    document.getElementById("status").textContent = isSetupPhase ? "Mise en place" : "TRAVAIL";
    document.getElementById("start-btn").textContent = "Démarrer";
    return;
  }
  
  // Nouveau démarrage
  resetWorkout();
  timerInterval = setInterval(timerTick, 1000);
}

function pauseWorkout() {
  if (!timerInterval) return;
  
  clearInterval(timerInterval); 
  timerInterval = null;
  isPaused = true;
  document.getElementById("status").textContent = "⏸ Pause";
  document.getElementById("start-btn").textContent = "Reprendre";
}

function resetWorkout() {
  if (timerInterval) {
    clearInterval(timerInterval); 
    timerInterval = null;
  }
  isSetupPhase = true;
  currentBlockIndex = -1;
  timeLeft = setupTime;
  isPaused = false;
  document.getElementById("start-btn").textContent = "Démarrer";
  updateDisplay();
}

function prevBlock() {
  if (!isSetupPhase && currentBlockIndex > 0) {
    currentBlockIndex -= 2;
    advanceBlock();
  }
}

function nextBlock() {
  if (!isSetupPhase) {
    advanceBlock();
  }
}

// ========== CONFIG ==========
function saveAll() {
  sequenceInputValue = document.getElementById("sequence-input").value.trim();
  setupTime = parseInt(document.getElementById("setup-time").value) || 10;
  
  // Validation de la séquence
  const blocks = parseSequence(sequenceInputValue);
  if (blocks.length === 0) {
    showError("Séquence invalide, non sauvegardée");
    return;
  }
  
  localStorage.setItem('chronoPro_exercises', JSON.stringify(exercises));
  localStorage.setItem('chronoPro_sequence', sequenceInputValue);
  localStorage.setItem('chronoPro_setupTime', setupTime);
  
  document.getElementById("total-time-info").textContent = `Temps total : ${formatTime(calculateTotalTime())}`;
  
  const s = document.getElementById("autosave-status");
  s.textContent = "✓ Sauvegardé";
  s.style.opacity = 1;
  setTimeout(() => s.style.opacity = 0, 2000);
  
  updateDisplay();
}

function renderExercises() {
  const list = document.getElementById("exercise-list");
  list.innerHTML = "";
  
  exercises.forEach((ex, i) => {
    const d = document.createElement("div");
    d.className = "exercise-entry";
    d.innerHTML = `
      <input type="text" value="${ex.name}" onchange="exercises[${i}].name=this.value;saveAll()">
      <input type="text" value="${ex.reps}" onchange="exercises[${i}].reps=this.value;saveAll()">
      <input type="number" value="${ex.workTime}" min="1" max="300" onchange="exercises[${i}].workTime=Math.max(1,parseInt(this.value)||30);saveAll()">
      <input type="text" placeholder="URL image" value="${ex.image}" onchange="exercises[${i}].image=this.value;saveAll()">
      <input type="file" accept="image/*" onchange="((f)=>{if(f){const r=new FileReader();r.onload=e=>{exercises[${i}].image=e.target.result;saveAll();renderExercises()};r.readAsDataURL(f)}})(this.files[0])">
      <button class="delete-btn" title="Supprimer" onclick="if(confirm('Supprimer cet exercice ?')){exercises.splice(${i},1);renderExercises();saveAll()}">✕</button>
    `;
    list.appendChild(d);
  });
}

// ========== EVENT LISTENERS ==========
document.getElementById("prev-btn").onclick = prevBlock;
document.getElementById("next-btn").onclick = nextBlock;
document.getElementById("start-btn").onclick = startWorkout;
document.getElementById("pause-btn").onclick = pauseWorkout;
document.getElementById("reset-btn").onclick = resetWorkout;

document.getElementById("config-btn").onclick = () => {
  const p = document.getElementById("config-panel");
  p.style.display = p.style.display === "block" ? "none" : "block";
  if (p.style.display === "block") {
    document.getElementById("sequence-input").value = sequenceInputValue;
    document.getElementById("setup-time").value = setupTime;
    renderExercises();
    saveAll();
  }
};

document.getElementById("add-exercise").onclick = () => {
  exercises.push({name:"Nouvel exo", reps:"8-12", workTime:40, image:""});
  renderExercises();
  saveAll();
};

document.getElementById("save-config").onclick = saveAll;

document.getElementById("export-config").onclick = () => {
  const data = {exercises, sequence: sequenceInputValue, setupTime};
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}));
  a.download = 'chrono_pro_v9_1_config.json';
  a.click();
};

document.getElementById("import-config").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  
  const r = new FileReader();
  r.onload = ev => {
    try {
      const d = JSON.parse(ev.target.result);
      exercises = d.exercises || [];
      sequenceInputValue = d.sequence || "1-P30-2";
      setupTime = d.setupTime || 10;
      
      saveAll();
      renderExercises();
      document.getElementById("sequence-input").value = sequenceInputValue;
      document.getElementById("setup-time").value = setupTime;
      
      alert("✓ Import V9.1 réussi !");
    } catch {
      alert("❌ Fichier JSON invalide");
    }
  };
  r.readAsText(file);
};

// ========== INITIALISATION ==========
renderExercises();
updateDisplay();
document.getElementById("total-time-info").textContent = `Temps total : ${formatTime(calculateTotalTime())}`;

// Test de validation au chargement
const testBlocks = parseSequence(sequenceInputValue);
if (testBlocks.length === 0) {
  showError("⚠ Séquence invalide au démarrage, vérifiez la configuration");
}
</script>
</body>
</html>
