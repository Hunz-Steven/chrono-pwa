<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chrono Pro</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#007bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  body{font-family:Arial,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:100vh;margin:0;background:#f0f0f0;padding:20px 0}
  #workout-container{text-align:center;background:white;padding:25px;border-radius:12px;box-shadow:0 6px 12px rgba(0,0,0,.15);max-width:600px;width:90%}
  #exercise-image{width:100%;max-width:300px;height:auto;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
  #timer{font-size:56px;font-weight:bold;margin:20px 0;color:#007bff}
  #exercise-info,#series-info,#status{font-size:20px;margin:10px 0;font-weight:600}
  #series-info{color:#555;font-weight:400}
  button{padding:12px 20px;font-size:16px;margin:6px 4px;cursor:pointer;border:none;border-radius:6px;background:#007bff;color:white;transition:all .2s}
  button:hover:not(:disabled){background:#0056b3;transform:translateY(-1px)}
  button:disabled{background:#ccc;cursor:not-allowed}
  #config-panel{display:none;margin-top:25px;padding:20px;background:#f8f9fa;border-radius:10px;width:90%;max-width:560px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
  #exercise-list{max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:6px;padding:8px;background:white;margin-bottom:15px}
  .exercise-entry{border-bottom:1px solid #eee;padding:12px 0;display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:14px}
  .exercise-entry input{padding:8px;font-size:14px;border:1px solid #ddd;border-radius:4px}
  .exercise-entry input[type="text"], input[type="number"]{width:100px}
  .exercise-entry input[type="text"]:nth-child(1){width:140px}
  #total-time-info,#autosave-status{font-size:14px;margin-top:8px}
  #total-time-info{color:#007bff;font-weight:600}
  #autosave-status{color:#28a745;opacity:0;transition:opacity .3s}
  .help{color:#666;font-size:13px;margin-top:5px;line-height:1.5}
  .legend{font-size:13px;color:#555;margin-bottom:8px}
  .delete-btn{background:#dc3545!important;padding:8px 12px!important;min-width:40px;border-radius:6px;font-size:18px}
  .delete-btn:hover{background:#c82333!important;transform:translateY(-1px)}
</style>
</head>
<body>

<div id="workout-container">
  <img id="exercise-image" src="https://i.imgur.com/IHCEoad.png" alt="Préparation">
  <div id="exercise-info">Préparation</div>
  <div id="series-info"></div>
  <div id="timer">00:10</div>
  <div id="status">Prêt à commencer</div>
  <div style="margin:20px 0">
    <button id="prev-btn">Précédent</button>
    <button id="next-btn">Suivant</button>
  </div>
  <button id="start-btn" style="font-size:18px;padding:16px 40px">Démarrer</button><br>
  <button id="pause-btn">Pause</button>
  <button id="reset-btn">Réinitialiser</button>
  <button id="config-btn">Configurer</button>
</div>

<div id="config-panel">
  <h2>Configuration</h2>
  <label>Mise en place (s) : <input type="number" id="setup-time" value="10" min="0"></label><br><br>
  <label>Séquence :</label>
  <input type="text" id="sequence-input" value="5x(1-2-3-P90)" style="width:100%;padding:10px;font-family:monospace;font-size:15px">
  <div class="help">
    Exemples :<br>
    • 1-2-3-P120 → enchaîne 1→2→3 puis 2 min repos<br>
    • 6x(1-P10-2-P10-3) → 6 tours avec 10s entre chaque<br>
    • 8x(1-P20) → EMOM 40s travail / 20s repos<br>
  </div>

  <h3>Exercices</h3>
  <div class="legend">[1] Nom [2] Répétitions [3] Temps travail [4] URL image [5] Image locale</div>
  <div id="exercise-list"></div>

  <button id="add-exercise">+ Exercice</button>
  <button id="save-config">Enregistrer</button>
  <button id="export-config">Exporter JSON</button><br><br>
  <label>Importer config : <input type="file" id="import-config" accept=".json"></label>
  <div id="total-time-info">Temps total : …</div>
  <div id="autosave-status"></div>
</div>

<script>
// ========== AUDIO (fix Android) ==========
let audioCtx = null;
function getAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const unlock = () => { audioCtx.resume(); };
    document.body.addEventListener('touchstart', unlock, {once:true});
    document.body.addEventListener('click', unlock, {once:true});
  }
  return audioCtx;
}
const beep = (freq = 800, duration = 200) => {
  const ctx = getAudioContext();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.connect(g); g.connect(ctx.destination);
  o.frequency.value = freq;
  o.type = 'sine';
  g.gain.setValueAtTime(0.001, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration/1000);
  o.start(); o.stop(ctx.currentTime + duration/1000);
};

// ========== DONNÉES ==========
let exercises = JSON.parse(localStorage.getItem('chronoPro_exercises')) || [
  {name:"Dips lestés",        reps:"3–5",  workTime:40, image:"https://images.unsplash.com/photo-1517836357463-d25dfeac3438"},
  {name:"HSPU / Pompes piquées", reps:"4–6", workTime:40, image:"https://images.unsplash.com/photo-1517838277536-f5f99be501cd"},
  {name:"Pompes lestées",     reps:"6–8", workTime:40, image:"https://images.unsplash.com/photo-1530822847156-5df3f8f02b07"},
  {name:"Tractions pronation", reps:"5–7", workTime:40, image:"https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b"}
];

let sequenceInputValue = localStorage.getItem('chronoPro_sequence') || "5x(1-2-3-P90)";
let setupTime = parseInt(localStorage.getItem('chronoPro_setupTime')) || 10;

let isSetupPhase = true;
let currentBlockIndex = -1;
let timeLeft = setupTime;
let timerInterval = null;
let isPaused = false;

// ========== PARSER + TEMPS TOTAL ==========
function parseSequence(input) {
  let rounds = 1;
  let clean = input.trim();
  const global = clean.match(/^(\d+)x\(([\s\S]+)\)$/);
  if (global) { rounds = parseInt(global[1]); clean = global[2]; }
  const blocks = [];
  clean.split('-').forEach(p => {
    p = p.trim();
    if (!p) return;
    if (p.toUpperCase().startsWith('P')) blocks.push({type:'rest', duration:parseInt(p.slice(1))||0});
    else { const id = parseInt(p); if (id>0) blocks.push({type:'exercise', id}); }
  });
  return {blocks, rounds};
}
function calculateTotalTime() {
  const {blocks, rounds} = parseSequence(sequenceInputValue);
  let t = setupTime;
  for (let r=0; r<rounds; r++) for (let b of blocks) {
    if (b.type==='exercise') t += (exercises[b.id-1]?.workTime || 30);
    else t += b.duration;
  }
  return t;
}
const formatTime = s => `${Math.floor(s/60)}m ${s%60}s`;
const formatMMSS = s => `${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;

// ========== AFFICHAGE ==========
function updateDisplay() {
  const img = document.getElementById("exercise-image");
  const info = document.getElementById("exercise-info");
  const series = document.getElementById("series-info");
  const status = document.getElementById("status");

  if (isSetupPhase) {
    info.textContent = "Préparation";
    series.textContent = "";
    img.src = "https://i.imgur.com/IHCEoad.png";
    status.textContent = "Mise en place";
  } else {
    const {blocks, rounds} = parseSequence(sequenceInputValue);
    const totalBlocks = blocks.length * rounds;
    if (currentBlockIndex >= totalBlocks) {
      info.textContent = "FINI !";
      series.textContent = `Terminé en ${rounds} tour${rounds>1?'s':''}`;
      img.src = "https://i.imgur.com/0pazk7c.png";
      status.textContent = "Bravo !";
    } else {
      const idx = currentBlockIndex % blocks.length;
      const round = Math.floor(currentBlockIndex / blocks.length) + 1;
      const block = blocks[idx];
      series.textContent = `Tour ${round}/${rounds} • Bloc ${idx+1}/${blocks.length}`;
      if (block.type === 'exercise') {
        const ex = exercises[block.id-1] || exercises[0];
        info.textContent = `${ex.name} (${ex.reps})`;
        img.src = ex.image || "https://via.placeholder.com/300?text=Exo";
        status.textContent = "TRAVAIL";
      } else {
        info.textContent = "Repos";
        img.src = "https://i.imgur.com/IHCEoad.png";
        status.textContent = `Repos ${block.duration}s`;
      }
    }
  }
  document.getElementById("timer").textContent = formatMMSS(timeLeft);
}

// ========== TIMER ==========
function playBlockStartSound(isWork) {
  if (isWork) beep(880, 350);
  else beep(660, 450);
}
function advanceBlock() {
  currentBlockIndex++;
  const {blocks, rounds} = parseSequence(sequenceInputValue);
  if (currentBlockIndex >= blocks.length * rounds) {
    clearInterval(timerInterval); timerInterval = null;
    beep(1200, 400);
    setTimeout(() => beep(1400, 400), 500);
    setTimeout(() => beep(1600, 800), 1000);
    updateDisplay();
    return;
  }
  const block = blocks[currentBlockIndex % blocks.length];
  if (block.type === 'exercise') {
    timeLeft = exercises[block.id-1]?.workTime || 30;
    playBlockStartSound(true);
  } else {
    timeLeft = block.duration;
    playBlockStartSound(false);
  }
  updateDisplay();
}
function timerTick() {
  if (timeLeft > 0) {
    if (timeLeft <= 5) beep(440 + timeLeft*80, 120);
    timeLeft--;
    document.getElementById("timer").textContent = formatMMSS(timeLeft);
    return;
  }
  if (isSetupPhase) {
    isSetupPhase = false;
    currentBlockIndex = -1;
    beep(1000, 500);
  }
  advanceBlock();
}

// ========== CONTROLES ==========
function startWorkout() {
  if (timerInterval) return;
  if (isPaused) { isPaused = false; timerInterval = setInterval(timerTick,1000); return; }
  resetWorkout();
  timerInterval = setInterval(timerTick,1000);
}
function pauseWorkout() {
  if (timerInterval) {
    clearInterval(timerInterval); timerInterval = null;
    isPaused = true;
    document.getElementById("status").textContent = "Pause";
    document.getElementById("start-btn").textContent = "Reprendre";
  }
}
function resetWorkout() {
  clearInterval(timerInterval); timerInterval = null;
  isSetupPhase = true; currentBlockIndex = -1; timeLeft = setupTime; isPaused = false;
  document.getElementById("start-btn").textContent = "Démarrer";
  updateDisplay();
}
function prevBlock() { if (!isSetupPhase && currentBlockIndex > 0) { currentBlockIndex -= 2; advanceBlock(); } }
function nextBlock() { if (!isSetupPhase) advanceBlock(); }

// ========== CONFIG ==========
function saveAll() {
  sequenceInputValue = document.getElementById("sequence-input").value.trim();
  setupTime = parseInt(document.getElementById("setup-time").value) || 10;
  localStorage.setItem('chronoPro_exercises', JSON.stringify(exercises));
  localStorage.setItem('chronoPro_sequence', sequenceInputValue);
  localStorage.setItem('chronoPro_setupTime', setupTime);
  document.getElementById("total-time-info").textContent = `Temps total : ${formatTime(calculateTotalTime())}`;
  const s = document.getElementById("autosave-status"); s.textContent = "Sauvegardé"; s.style.opacity=1;
  setTimeout(()=>s.style.opacity=0,2000);
  updateDisplay();
}
function renderExercises() {
  const list = document.getElementById("exercise-list"); list.innerHTML = "";
  exercises.forEach((ex,i) => {
    const d = document.createElement("div"); d.className="exercise-entry";
    d.innerHTML = `
      <input type="text" value="${ex.name}" onchange="exercises[${i}].name=this.value;saveAll()">
      <input type="text" value="${ex.reps}" onchange="exercises[${i}].reps=this.value;saveAll()">
      <input type="number" value="${ex.workTime}" onchange="exercises[${i}].workTime=parseInt(this.value)||30;saveAll()">
      <input type="text" value="${ex.image}" onchange="exercises[${i}].image=this.value;saveAll()">
      <input type="file" accept="image/*" onchange="((f)=>{if(f){const r=new FileReader();r.onload=e=>{exercises[${i}].image=e.target.result;saveAll();renderExercises()};r.readAsDataURL(f)}})(this.files[0])">
      <button class="delete-btn" title="Supprimer" onclick="exercises.splice(${i},1);renderExercises();saveAll()">Delete</button>
    `;
    list.appendChild(d);
  });
}

// ========== BOUTONS (la ligne qui manquait !) ==========
document.getElementById("prev-btn").onclick = prevBlock;
document.getElementById("next-btn").onclick = nextBlock;
document.getElementById("start-btn").onclick = startWorkout;
document.getElementById("pause-btn").onclick = pauseWorkout;
document.getElementById("reset-btn").onclick = resetWorkout;
document.getElementById("config-btn").onclick = () => {
  const p = document.getElementById("config-panel");
  p.style.display = p.style.display==="block" ? "none" : "block";
  if (p.style.display==="block") {
    document.getElementById("sequence-input").value = sequenceInputValue;
    document.getElementById("setup-time").value = setupTime;
    renderExercises();
    saveAll();
  }
};

document.getElementById("add-exercise").onclick = () => { exercises.push({name:"Nouvel exo",reps:"8-12",workTime:40,image:""}); renderExercises(); saveAll(); };
document.getElementById("save-config").onclick = saveAll;
document.getElementById("export-config").onclick = () => {
  const data = {exercises, sequence:sequenceInputValue, setupTime};
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}));
  a.download = 'chrono_pro_config.json'; a.click();
};
document.getElementById("import-config").onchange = e => {
  const file = e.target.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ev => {
    try {
      const d = JSON.parse(ev.target.result);
      exercises = d.exercises || [];
      sequenceInputValue = d.sequence || "1-2-3";
      setupTime = d.setupTime || 10;
      saveAll(); renderExercises();
      document.getElementById("sequence-input").value = sequenceInputValue;
      document.getElementById("setup-time").value = setupTime;
      alert("Import réussi !");
    } catch { alert("Fichier invalide"); }
  };
  r.readAsText(file);
};

// ========== INIT ==========
renderExercises();
updateDisplay();
document.getElementById("total-time-info").textContent = `Temps total : ${formatTime(calculateTotalTime())}`;
</script>
</body>
</html>
